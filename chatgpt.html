<!DOCTYPE html>
<html>

    <head>
        <meta charset="UTF-8">

        <style>
            body {
                font-family: Arial, sans-serif;
                background-color: #f2f2f2;
            }

            h1,
            h2 {
                text-align: center;
                border-bottom: 1px solid #ccc;
            }

            div.head {
                text-align: center;
            }

            div.content {
                display: flex;
                align-items: center;
                justify-content: center;
                flex-direction: column;
            }

            div.content>* {
                margin: 5px;
            }

            #apiKey,
            #model {
                padding: 12px 20px;
                margin: 8px 0;
                box-sizing: border-box;
                border: 2px solid #ccc;
                border-radius: 4px;
            }

            #inputMessage {
                padding: 12px 20px;
                margin: 8px 0;
                box-sizing: border-box;
                border: 2px solid #ccc;
                border-radius: 4px;
                width: 50%;
                height: 200px;
            }

            button {
                background-color: #4CAF50;
                color: white;
                padding: 14px 20px;
                margin: 8px 0;
                border: none;
                border-radius: 4px;
                cursor: pointer;
            }

            button:hover {
                background-color: #45a049;
            }

            #outputArea {
                border: 1px solid #ccc;
                padding: 10px;
                max-height: 300px;
                overflow-y: auto;
            }
        </style>

        <title>ChatGPT</title>
    </head>

    <body>
        <h1>ChatGPT</h1>
        <div style="text-align: center;"><span>支持流式输出，不支持上下文，每次对话都是独立的</span></div>
        <div class="head">
            <label for="apiKey">API Key:</label>
            <input type="text" id="apiKey" placeholder="在这里输入API Key">
            <label for="model">Model:</label>
            <select name="model" id="model">
                <option value="gpt-3.5-turbo" selected>
                    gpt-3.5-turbo
                </option>
                <option value="gpt-3.5-turbo-16k">
                    gpt-3.5-turbo-16k
                </option>
                <option value="gpt-4">
                    gpt-4
                </option>
                <option value="gpt-4-32k">
                    gpt-4-32k
                </option>
            </select>
            <!-- <input type="text" id="model" placeholder="在这里输入Model"> -->
        </div>
        <div class="content">
            <label for="inputMessage">输入内容:</label>
            <textarea id="inputMessage" placeholder="在这里输入内容"></textarea>
            <button onclick="callOpenAI()">提交</button>
        </div>

        <div class="content">
            <h2>输出内容:</h2>
            <p id="outputArea">等待提问</p>
        </div>

        <script>
            async function callOpenAI() {
                try {
                    // 获取API Key
                    const apiKey = document.getElementById("apiKey").value;

                    // 获取Model
                    const model = document.getElementById("model").value;

                    // 获取输入框中的内容  
                    const inputMessage = document.getElementById("inputMessage").value;

                    const outputArea = document.getElementById("outputArea");
                    outputArea.textContent = "思考中……";
                    // 调用OpenAI接口
                    const response = await fetch("https://openai.iblogc.com/v1/chat/completions", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "Authorization": "Bearer " + apiKey
                        },
                        body: JSON.stringify({
                            model: model,
                            messages: [
                                // {
                                //     role: "system",
                                //     content: ''
                                // },
                                {
                                    role: "user",
                                    content: inputMessage
                                }
                            ],
                            stream: true,
                            temperature: 0
                        })
                    });

                    // 处理流式输出数据
                    // 使用Response对象的body属性来获取流式输出数据
                    const reader = response.body.getReader();
                    // 清空输出区域
                    outputArea.textContent = "";
                    // 逐步处理流式输出数据
                    while (true) {
                        const { done, value } = await reader.read();

                        if (done) {
                            break;
                        }

                        // 将数据块转换为文本并追加到输出区域
                        const text = new TextDecoder().decode(value);
                        text.split("\n").filter(line => line).forEach(line => {
                            var lineText = line.replace(/^data: /g, '')
                            if (lineText != "[DONE]") {
                                rsp = JSON.parse(lineText)
                                console.log(rsp)
                                content = rsp.choices[0].delta.content
                                console.log(content)
                                if (content) {
                                    outputArea.textContent += content;
                                }
                            }
                        })
                    }

                } catch (error) {
                    // 输出错误信息
                    outputArea.textContent = error;
                }
            }
        </script>

    </body>

</html>