{"name":"Flux","postlist":[{"title":"WebFlux中mongo操作-Transaction","slug":"WebFlux中mongo操作-Transaction","date":"2020-01-17T07:16:46.000Z","updated":"2020-01-17T08:01:36.430Z","comments":true,"path":"api/articles/WebFlux中mongo操作-Transaction.json","excerpt":"<br><br>","cover":null,"content":"<p><br><br><a id=\"more\"></a><br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@PostMapping</span>(<span class=\"string\">\"/test\"</span>)</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> Mono <span class=\"title\">testA</span><span class=\"params\">(@RequestParam <span class=\"keyword\">boolean</span> exception)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> embedService.saveAC(<span class=\"keyword\">new</span> ADocument(<span class=\"string\">\"张三\"</span>), <span class=\"keyword\">new</span> CDocument(<span class=\"string\">\"李四\"</span>), exception);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Override</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> Mono&lt;Boolean&gt; <span class=\"title\">saveAC</span><span class=\"params\">(ADocument aDocument, CDocument cDocument, <span class=\"keyword\">boolean</span> exception)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> reactiveMongoTemplate.inTransaction()</span><br><span class=\"line\">    <span class=\"comment\">//所有文档的持久化操作都只能在单独一个execute函数中汇总实现</span></span><br><span class=\"line\">    .execute(action -&gt; action.insert(aDocument)</span><br><span class=\"line\">             .flatMap(a -&gt; &#123;</span><br><span class=\"line\">               cDocument.setName(a.getName() + <span class=\"string\">\"copy\"</span>);</span><br><span class=\"line\">               <span class=\"keyword\">return</span> action.insert(cDocument)</span><br><span class=\"line\">                 .map(d -&gt; &#123;</span><br><span class=\"line\">                   <span class=\"keyword\">if</span> (exception) &#123;</span><br><span class=\"line\">                     <span class=\"comment\">//测试跨文档的异常回滚</span></span><br><span class=\"line\">                     <span class=\"keyword\">throw</span> Exceptions.propagate(<span class=\"keyword\">new</span> RuntimeException(<span class=\"string\">\"模拟异常的出现\"</span>));</span><br><span class=\"line\">                   &#125;</span><br><span class=\"line\">                   <span class=\"keyword\">return</span> d;</span><br><span class=\"line\">                 &#125;);</span><br><span class=\"line\">             &#125;)</span><br><span class=\"line\">            )</span><br><span class=\"line\">    <span class=\"comment\">//如果里面是个mono，则用next取出第一个元素就是里面的mono</span></span><br><span class=\"line\">    .next()</span><br><span class=\"line\">    .map(list -&gt; &#123;</span><br><span class=\"line\">      <span class=\"comment\">//需要注意，在execute之外的函数中产生的异常，不会触发事务的回滚。</span></span><br><span class=\"line\">      <span class=\"comment\">//                    if (exception) &#123;</span></span><br><span class=\"line\">      <span class=\"comment\">//                        throw Exceptions.propagate(new RuntimeException(\"模拟异常的出现\"));</span></span><br><span class=\"line\">      <span class=\"comment\">//                    &#125;</span></span><br><span class=\"line\">      <span class=\"keyword\">return</span> Boolean.TRUE;</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>flux的数据库操作，在有事务的前提下不能用flatMap，要用事务不能用flatMap要用concatMap保持有序</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@PostMapping</span>(<span class=\"string\">\"/test\"</span>)</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> Mono <span class=\"title\">testA</span><span class=\"params\">(@RequestParam <span class=\"keyword\">boolean</span> exception)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> embedService.saveAC(<span class=\"keyword\">new</span> ADocument(<span class=\"string\">\"张三\"</span>), <span class=\"keyword\">new</span> CDocument(<span class=\"string\">\"李四\"</span>), exception);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Override</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> Mono&lt;Boolean&gt; <span class=\"title\">saveAC</span><span class=\"params\">(ADocument aDocument, CDocument cDocument, <span class=\"keyword\">boolean</span> exception)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> reactiveMongoTemplate.inTransaction()</span><br><span class=\"line\">    <span class=\"comment\">//所有文档的持久化操作都只能在单独一个execute函数中汇总实现</span></span><br><span class=\"line\">    .execute(action -&gt; Flux.fromIterable(<span class=\"string\">\"1\"</span>, <span class=\"string\">\"2\"</span>, <span class=\"string\">\"3\"</span>)</span><br><span class=\"line\">             <span class=\"comment\">//如果是个flux此处要用concatMap保持有序不能用flatMap</span></span><br><span class=\"line\">             .concatMap(i -&gt; action.insert(aDocument)</span><br><span class=\"line\">                        .flatMap(a -&gt; &#123;</span><br><span class=\"line\">                          cDocument.setName(a.getName() + <span class=\"string\">\"copy\"</span>);</span><br><span class=\"line\">                          <span class=\"keyword\">return</span> action.insert(cDocument)</span><br><span class=\"line\">                            .map(d -&gt; &#123;</span><br><span class=\"line\">                              <span class=\"keyword\">if</span> (exception) &#123;</span><br><span class=\"line\">                                <span class=\"comment\">//测试跨文档的异常回滚</span></span><br><span class=\"line\">                                <span class=\"keyword\">throw</span> Exceptions.propagate(<span class=\"keyword\">new</span> RuntimeException(<span class=\"string\">\"模拟异常的出现\"</span>));</span><br><span class=\"line\">                              &#125;</span><br><span class=\"line\">                              <span class=\"keyword\">return</span> d;</span><br><span class=\"line\">                            &#125;);</span><br><span class=\"line\">                        &#125;));</span><br><span class=\"line\">            )</span><br><span class=\"line\">    <span class=\"comment\">//如果里面返回的就是一个flux则不需要使用next</span></span><br><span class=\"line\">    <span class=\"comment\">//.next()</span></span><br><span class=\"line\">    .map(list -&gt; &#123;</span><br><span class=\"line\">      <span class=\"comment\">//需要注意，在execute之外的函数中产生的异常，不会触发事务的回滚。</span></span><br><span class=\"line\">      <span class=\"comment\">//                    if (exception) &#123;</span></span><br><span class=\"line\">      <span class=\"comment\">//                        throw Exceptions.propagate(new RuntimeException(\"模拟异常的出现\"));</span></span><br><span class=\"line\">      <span class=\"comment\">//                    &#125;</span></span><br><span class=\"line\">      <span class=\"keyword\">return</span> Boolean.TRUE;</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>","raw":null,"categories":[{"name":"程序猿","path":"api/categories/程序猿.json"}],"tags":[{"name":"Java","path":"api/tags/Java.json"},{"name":"Reactive","path":"api/tags/Reactive.json"},{"name":"事务","path":"api/tags/事务.json"},{"name":"mongo","path":"api/tags/mongo.json"},{"name":"数据库","path":"api/tags/数据库.json"},{"name":"Flux","path":"api/tags/Flux.json"}]}]}