{"name":"version","postlist":[{"title":"Django REST framework之版本号version","slug":"django-rest-framework之版本号version","date":"2016-01-28T15:29:58.000Z","updated":"2020-08-15T03:05:41.339Z","comments":true,"path":"api/articles/django-rest-framework之版本号version.json","excerpt":"<br><br>","cover":null,"content":"<p><br><br><a id=\"more\"></a><br>drf支持以下形式传输版本号</p>\n<ul>\n<li><p>header</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /bookings/ HTTP/1.1</span><br><span class=\"line\">Host: example.com</span><br><span class=\"line\">Accept: application/json; version=1.0</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>URL Path </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /v1/bookings/ HTTP/1.1</span><br><span class=\"line\">Host: example.com</span><br><span class=\"line\">Accept: application/json</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">urlpatterns = [</span><br><span class=\"line\">    url(</span><br><span class=\"line\">        r&apos;^(?P&lt;version&gt;(v1|v2))/bookings/$&apos;,</span><br><span class=\"line\">        bookings_list,</span><br><span class=\"line\">        name=&apos;bookings-list&apos;</span><br><span class=\"line\">    ),</span><br><span class=\"line\">]</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Namespace</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /v1/something/ HTTP/1.1</span><br><span class=\"line\">Host: example.com</span><br><span class=\"line\">Accept: application/json</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">urlpatterns = [</span><br><span class=\"line\">    url(r&apos;^v1/bookings/&apos;, include(&apos;bookings.urls&apos;, namespace=&apos;v1&apos;)),</span><br><span class=\"line\">    url(r&apos;^v2/bookings/&apos;, include(&apos;bookings.urls&apos;, namespace=&apos;v2&apos;))</span><br><span class=\"line\">]</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Host Name</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /bookings/ HTTP/1.1</span><br><span class=\"line\">Host: v1.example.com</span><br><span class=\"line\">Accept: application/json</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Query Parameter</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /something/?version=0.1 HTTP/1.1</span><br><span class=\"line\">Host: example.com</span><br><span class=\"line\">Accept: application/json</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>drf默认是关闭版本控制功能，如需要开启，可在<code>settings.py</code>里添加对应的设置<br><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">REST_FRAMEWORK = &#123;</span><br><span class=\"line\">    ……</span><br><span class=\"line\">    <span class=\"string\">'DEFAULT_VERSIONING_CLASS'</span>: <span class=\"string\">'rest_framework.versioning.AcceptHeaderVersioning'</span>,</span><br><span class=\"line\">    <span class=\"comment\"># 'DEFAULT_VERSIONING_CLASS': 'rest_framework.versioning.URLPathVersioning',</span></span><br><span class=\"line\">    <span class=\"comment\"># 'DEFAULT_VERSIONING_CLASS': 'rest_framework.versioning.NamespaceVersioning',</span></span><br><span class=\"line\">    <span class=\"comment\"># 'DEFAULT_VERSIONING_CLASS': 'rest_framework.versioning.HostNameVersioning',</span></span><br><span class=\"line\">    <span class=\"comment\"># 'DEFAULT_VERSIONING_CLASS': 'rest_framework.versioning.QueryParameterVersioning',</span></span><br><span class=\"line\">    ……</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>当然，你也可以为每个视图单独添加，不过不建议这么做<br><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ProfileList</span><span class=\"params\">(APIView)</span>:</span></span><br><span class=\"line\">    versioning_class = versioning.QueryParameterVersioning</span><br></pre></td></tr></table></figure></p>\n<p>开启版本控制之后，就可以从<code>request</code>取得版本号<code>request.version</code>（当然你<code>settings.py</code>里配置的是什么方式，就用什么方式传版本号，这样就才可以从<code>request</code>里获取到版本号）<br><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">get_serializer_class</span><span class=\"params\">(self)</span>:</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> self.request.version == <span class=\"string\">'v1'</span>:</span><br><span class=\"line\">        <span class=\"keyword\">return</span> AccountSerializerVersion1</span><br><span class=\"line\">    <span class=\"keyword\">return</span> AccountSerializer</span><br></pre></td></tr></table></figure></p>\n<p>启动版本控制后，url逆向解析方法需要传入<code>request</code>参数<br><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> rest_framework.reverse <span class=\"keyword\">import</span> reverse</span><br><span class=\"line\"> </span><br><span class=\"line\">reverse(<span class=\"string\">'bookings-list'</span>, request=request)</span><br></pre></td></tr></table></figure></p>\n<p>如果是使用Namespace时的版本控制，因为配置了<code>DEFAULT_VERSIONING_CLASS</code>，所以设置view_name时不需要添加<code>v1:</code>前缀，见django rest framework入门笔记.md</p>\n<p>最后在设置里添加以下全局设置来控制能访问的版本<br><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">'DEFAULT_VERSION'</span>: <span class=\"keyword\">None</span>, <span class=\"comment\">#默认版本，request里没有版本信息时，使用的版本，默认为None</span></span><br><span class=\"line\"><span class=\"string\">'ALLOWED_VERSIONS'</span>: [<span class=\"keyword\">None</span>, <span class=\"string\">'v1'</span>, <span class=\"string\">'v2'</span>], <span class=\"comment\">#允许访问的版本，如果访问的版本不在列表中，则会抛出异常</span></span><br></pre></td></tr></table></figure></p>\n<p>也可以为每个视图单独设置<br><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> rest_framework.versioning <span class=\"keyword\">import</span> URLPathVersioning</span><br><span class=\"line\"><span class=\"keyword\">from</span> rest_framework.views <span class=\"keyword\">import</span> APIView</span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ExampleVersioning</span><span class=\"params\">(URLPathVersioning)</span>:</span></span><br><span class=\"line\">    default_version = ...</span><br><span class=\"line\">    allowed_versions = ...</span><br><span class=\"line\">    version_param = ...</span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ExampleView</span><span class=\"params\">(APIVIew)</span>:</span></span><br><span class=\"line\">    versioning_class = ExampleVersioning</span><br></pre></td></tr></table></figure></p>\n","raw":null,"categories":[{"name":"程序猿","path":"api/categories/程序猿.json"}],"tags":[{"name":"Django","path":"api/tags/Django.json"},{"name":"restful","path":"api/tags/restful.json"},{"name":"api","path":"api/tags/api.json"},{"name":"version","path":"api/tags/version.json"}]}]}