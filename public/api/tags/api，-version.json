{"name":"api，-version","postlist":[{"title":"Django Rest framework里的API请求频率控制","slug":"django-rest-framework里的api请求频率控制","date":"2016-12-17T06:48:19.000Z","updated":"2020-08-15T03:05:17.000Z","comments":true,"path":"api/articles/django-rest-framework里的api请求频率控制.json","excerpt":"<br /><br>","cover":null,"content":"<p><br /><br><span id=\"more\"></span></p>\n<h2 id=\"更新记录\"><a href=\"#更新记录\" class=\"headerlink\" title=\"更新记录\"></a>更新记录</h2><p>2016-08-25 初稿</p>\n<p><code>Django Rest framework</code>有自带的频率控制配置</p>\n<h2 id=\"全局设置\"><a href=\"#全局设置\" class=\"headerlink\" title=\"全局设置\"></a>全局设置</h2><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">REST_FRAMEWORK = &#123;</span><br><span class=\"line\">    <span class=\"string\">&#x27;DEFAULT_THROTTLE_CLASSES&#x27;</span>: (</span><br><span class=\"line\">        <span class=\"comment\"># 开启匿名用户接口请求频率限制</span></span><br><span class=\"line\">        <span class=\"string\">&#x27;rest_framework.throttling.AnonRateThrottle&#x27;</span>,</span><br><span class=\"line\">        <span class=\"comment\"># 开启授权用户接口请求频率限制</span></span><br><span class=\"line\">        <span class=\"string\">&#x27;rest_framework.throttling.UserRateThrottle&#x27;</span></span><br><span class=\"line\">    ),</span><br><span class=\"line\">    <span class=\"string\">&#x27;DEFAULT_THROTTLE_RATES&#x27;</span>: &#123;</span><br><span class=\"line\">        <span class=\"comment\"># 频率限制有second, minute, hour, day</span></span><br><span class=\"line\">        <span class=\"comment\"># 匿名用户请求频率</span></span><br><span class=\"line\">        <span class=\"string\">&#x27;anon&#x27;</span>: <span class=\"string\">&#x27;100/day&#x27;</span>,</span><br><span class=\"line\">        <span class=\"comment\"># 授权用户请求频率</span></span><br><span class=\"line\">        <span class=\"string\">&#x27;user&#x27;</span>: <span class=\"string\">&#x27;1000/day&#x27;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"类视图单独配置\"><a href=\"#类视图单独配置\" class=\"headerlink\" title=\"类视图单独配置\"></a>类视图单独配置</h2><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> rest_framework.response <span class=\"keyword\">import</span> Response</span><br><span class=\"line\"><span class=\"keyword\">from</span> rest_framework.throttling <span class=\"keyword\">import</span> UserRateThrottle</span><br><span class=\"line\"><span class=\"keyword\">from</span> rest_framework.views <span class=\"keyword\">import</span> APIView</span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">ExampleView</span>(<span class=\"title class_ inherited__\">APIView</span>):</span><br><span class=\"line\">    throttle_classes = (UserRateThrottle,)</span><br><span class=\"line\"> </span><br><span class=\"line\">    <span class=\"keyword\">def</span> <span class=\"title function_\">get</span>(<span class=\"params\">self, request, <span class=\"built_in\">format</span>=<span class=\"literal\">None</span></span>):</span><br><span class=\"line\">        content = &#123;</span><br><span class=\"line\">            <span class=\"string\">&#x27;status&#x27;</span>: <span class=\"string\">&#x27;request was permitted&#x27;</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> Response(content)</span><br></pre></td></tr></table></figure>\n<h2 id=\"方法视图配置\"><a href=\"#方法视图配置\" class=\"headerlink\" title=\"方法视图配置\"></a>方法视图配置</h2><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@api_view(<span class=\"params\">[<span class=\"string\">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class=\"line\"><span class=\"meta\">@throttle_classes(<span class=\"params\">[UserRateThrottle]</span>)</span></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">example_view</span>(<span class=\"params\">request, <span class=\"built_in\">format</span>=<span class=\"literal\">None</span></span>):</span><br><span class=\"line\">    content = &#123;</span><br><span class=\"line\">        <span class=\"string\">&#x27;status&#x27;</span>: <span class=\"string\">&#x27;request was permitted&#x27;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> Response(content)</span><br></pre></td></tr></table></figure>\n<h2 id=\"自定义\"><a href=\"#自定义\" class=\"headerlink\" title=\"自定义\"></a>自定义</h2><p>方法一：<br><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">BurstRateThrottle</span>(<span class=\"title class_ inherited__\">UserRateThrottle</span>):</span><br><span class=\"line\">    scope = <span class=\"string\">&#x27;burst&#x27;</span></span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">SustainedRateThrottle</span>(<span class=\"title class_ inherited__\">UserRateThrottle</span>):</span><br><span class=\"line\">    scope = <span class=\"string\">&#x27;sustained&#x27;</span></span><br><span class=\"line\">...<span class=\"keyword\">and</span> the following settings.</span><br></pre></td></tr></table></figure></p>\n<p><code>settings.py</code><br><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">REST_FRAMEWORK = &#123;</span><br><span class=\"line\">    <span class=\"string\">&#x27;DEFAULT_THROTTLE_CLASSES&#x27;</span>: (</span><br><span class=\"line\">        <span class=\"string\">&#x27;example.throttles.BurstRateThrottle&#x27;</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;example.throttles.SustainedRateThrottle&#x27;</span></span><br><span class=\"line\">    ),</span><br><span class=\"line\">    <span class=\"string\">&#x27;DEFAULT_THROTTLE_RATES&#x27;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&#x27;burst&#x27;</span>: <span class=\"string\">&#x27;60/min&#x27;</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;sustained&#x27;</span>: <span class=\"string\">&#x27;1000/day&#x27;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure><br>然后在视图里设置<code>throttle_classes</code>即可。</p>\n<p>方法二：<br><code>settings.py</code><br><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">REST_FRAMEWORK = &#123;</span><br><span class=\"line\">    <span class=\"string\">&#x27;DEFAULT_THROTTLE_CLASSES&#x27;</span>: (</span><br><span class=\"line\">        <span class=\"string\">&#x27;rest_framework.throttling.ScopedRateThrottle&#x27;</span>,</span><br><span class=\"line\">    ),</span><br><span class=\"line\">    <span class=\"string\">&#x27;DEFAULT_THROTTLE_RATES&#x27;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&#x27;contacts&#x27;</span>: <span class=\"string\">&#x27;1000/day&#x27;</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;uploads&#x27;</span>: <span class=\"string\">&#x27;20/day&#x27;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure><br>然后在类视图中设置<code>throttle_scope</code><br><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">ContactListView</span>(<span class=\"title class_ inherited__\">APIView</span>):</span><br><span class=\"line\">    throttle_scope = <span class=\"string\">&#x27;contacts&#x27;</span></span><br><span class=\"line\">    ...</span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">ContactDetailView</span>(<span class=\"title class_ inherited__\">APIView</span>):</span><br><span class=\"line\">    throttle_scope = <span class=\"string\">&#x27;contacts&#x27;</span></span><br><span class=\"line\">    ...</span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">UploadView</span>(<span class=\"title class_ inherited__\">APIView</span>):</span><br><span class=\"line\">    throttle_scope = <span class=\"string\">&#x27;uploads&#x27;</span></span><br><span class=\"line\">    ...</span><br></pre></td></tr></table></figure></p>\n<p><strong>1. 匿名用户频率如果设置大于授权用户频率，则以授权用户频率为准。</strong><br><strong>2. 频率限制是针对单个接口的频率，而不是所有接口的频率。</strong></p>\n","raw":null,"categories":[],"tags":[{"name":"django","path":"api/tags/django.json"},{"name":"restful","path":"api/tags/restful.json"},{"name":"api，-version","path":"api/tags/api，-version.json"}]}]}