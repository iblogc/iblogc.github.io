{"name":"Python","postlist":[{"title":"Django内置的flatpages应用","slug":"django内置的flatpages应用","date":"2015-09-08T13:17:55.000Z","updated":"2015-09-08T13:17:55.000Z","comments":true,"path":"api/articles/django内置的flatpages应用.json","excerpt":"不知道大家平时写网站时类似「关于页面」，「用户协议」这类页面是如何处理的。这里列出了这类页面的两个特点：页面数据简单（不会有很多动态数据展示）;有更新但频率不高;如果要为这类页面展示建立多个数据表，显然是很浪费的行为，但如果直接写成静态页面文件，更新又比较很麻烦，这时候就可以使用flatpages来解决这类问题了。<br>","cover":null,"content":"<p>不知道大家平时写网站时类似「关于页面」，「用户协议」这类页面是如何处理的。这里列出了这类页面的两个特点：</p>\n<ol>\n<li>页面数据简单（不会有很多动态数据展示）;</li>\n<li>有更新但频率不高;</li>\n</ol>\n<p>如果要为这类页面展示建立多个数据表，显然是很浪费的行为，但如果直接写成静态页面文件，更新又比较很麻烦，这时候就可以使用<code>flatpages</code>来解决这类问题了。<br><a id=\"more\"></a></p>\n<p><code>django.contrib.flatpages</code>是<code>Django</code>的内置app，用于添加更新的一些简单的页面，具体设置，请继续查看以下步骤。</p>\n<h2 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h2><p>首先确保<code>INSTALLED_APPS</code>中已经存在<code>django.contrib.sites</code>，因为<code>django.contrib.flatpages</code>依赖于此包。<br><code>settings.py</code><br><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">INSTALLED_APPS = (</span><br><span class=\"line\">    <span class=\"comment\"># ...</span></span><br><span class=\"line\">    <span class=\"string\">'django.contrib.sites'</span>,</span><br><span class=\"line\">    <span class=\"string\">'django.contrib.flatpages'</span>,</span><br><span class=\"line\">)</span><br><span class=\"line\"><span class=\"comment\"># ...</span></span><br><span class=\"line\"><span class=\"comment\"># 如果没有设置`SITE_ID`值，则需要设置，这里直接设置为1</span></span><br><span class=\"line\">SITE_ID = <span class=\"number\">1</span></span><br></pre></td></tr></table></figure></p>\n<p>执行<code>python manage.py migrate</code>建表</p>\n<h2 id=\"配置\"><a href=\"#配置\" class=\"headerlink\" title=\"配置\"></a>配置</h2><p>路由配置可先以有多种形式<br><code>urls.py</code><br>第一种（需放在最后，推荐）<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">from django.contrib.flatpages import views</span><br><span class=\"line\">urlpatterns += [</span><br><span class=\"line\">    url(r&apos;^(?P&lt;url&gt;.*/)$&apos;, views.flatpage),</span><br><span class=\"line\">]</span><br></pre></td></tr></table></figure></p>\n<p>第二种（每个页面都需要写一个url，推荐）<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">from django.contrib.flatpages import views</span><br><span class=\"line\">urlpatterns = [</span><br><span class=\"line\">    url(r&apos;^about-us/$&apos;, views.flatpage, &#123;&apos;url&apos;: &apos;/about-us/&apos;&#125;, name=&apos;about&apos;),</span><br><span class=\"line\">    url(r&apos;^license/$&apos;, views.flatpage, &#123;&apos;url&apos;: &apos;/license/&apos;&#125;, name=&apos;license&apos;),</span><br><span class=\"line\">]</span><br></pre></td></tr></table></figure></p>\n<p>或者，如果你不想配置路由，还有一种更简单的方法，直接在<code>settings.py</code>的里添加中间件<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">MIDDLEWARE_CLASSES = (</span><br><span class=\"line\">    # ...</span><br><span class=\"line\">    &apos;django.contrib.flatpages.middleware.FlatpageFallbackMiddleware&apos;,</span><br><span class=\"line\">)</span><br></pre></td></tr></table></figure></p>\n<p><em>为确保配置生效，保险的方法是把<code>django.contrib.flatpages.middleware.FlatpageFallbackMiddleware</code>放在最后一行</em></p>\n<h2 id=\"管理flatpages\"><a href=\"#管理flatpages\" class=\"headerlink\" title=\"管理flatpages\"></a>管理<code>flatpages</code></h2><p>默认的你可以登录超级管理员后台（如果开启），找到<code>Flat pages</code>，进去点击添加，可以看到可配置的选项有，<code>URL</code> <code>Title</code> <code>Content</code> <code>Site</code> <code>Enable comments</code> <code>Registration required</code> <code>Template name</code></p>\n<h3 id=\"数据项说明\"><a href=\"#数据项说明\" class=\"headerlink\" title=\"数据项说明\"></a>数据项说明</h3><ul>\n<li><code>URL</code>:  页面所处的 URL，不包括域名，但是包含前导斜杠 (例如 /about/contact/ )</li>\n<li><code>Title</code>: 页面的标题，框架不对它作任何特殊处理。由你通过模板来显示它</li>\n<li><code>Content</code>: 页面的内容 (即 HTML 页面)，框架不会对它作任何特别处理。由你负责使用模板来显示</li>\n<li><code>Site</code>: 页面放置的站点，该项设置集成了 Django 多站点框架</li>\n<li><code>Enable comments</code>: 是否允许该简单页面使用评论，框架不对此做任何特别处理。你可在模板中检查该值并根据需要显示评论窗体</li>\n<li><code>Registration required</code>: 是否注册用户才能查看此简单页面，该设置项集成了 Djangos 验证/用户框架，该框架于第十二章详述。</li>\n<li><code>Template name</code>: 用来解析该简单页面的模板名称，这是一个可选项，如果未指定模板或该模板不存在，系统会退而使用默认模板 <code>flatpages/default.html</code>（我在<code>Django1.8.4</code>里死活没找到，只好自己写好一个扔进去）</li>\n</ul>\n<p>当添加相应的数据后，剩下工作就交给<code>flatpages</code>吧，如果你是使用中间件形式的，则<code>flatpages</code>会在配置完所有<code>urls.py</code>后，没有找到配置到对应的<code>URL</code>，才会到<code>flatpages</code>中查找，如果还是找不到，则会引发<code>Http404</code>异常，即<code>FlatpageFallbackMiddleware</code>只在<code>404</code>时会被激活，而不会在<code>500</code>或其它错误响应时被激活。</p>\n<p>如果你需要自己定制，则可以针对<code>django/contrib/flatpages/models.py</code>自己写增删改方法就可以。<br><code>models.py</code><br><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">FlatPage</span><span class=\"params\">(models.Model)</span>:</span></span><br><span class=\"line\">    url = models.CharField(_(<span class=\"string\">'URL'</span>), max_length=<span class=\"number\">100</span>, db_index=<span class=\"keyword\">True</span>)</span><br><span class=\"line\">    title = models.CharField(_(<span class=\"string\">'title'</span>), max_length=<span class=\"number\">200</span>)</span><br><span class=\"line\">    content = models.TextField(_(<span class=\"string\">'content'</span>), blank=<span class=\"keyword\">True</span>)</span><br><span class=\"line\">    enable_comments = models.BooleanField(_(<span class=\"string\">'enable comments'</span>), default=<span class=\"keyword\">False</span>)</span><br><span class=\"line\">    template_name = models.CharField(_(<span class=\"string\">'template name'</span>), max_length=<span class=\"number\">70</span>, blank=<span class=\"keyword\">True</span>,</span><br><span class=\"line\">        help_text=_(</span><br><span class=\"line\">            <span class=\"string\">\"Example: 'flatpages/contact_page.html'. If this isn't provided, \"</span></span><br><span class=\"line\">            <span class=\"string\">\"the system will use 'flatpages/default.html'.\"</span></span><br><span class=\"line\">        ),</span><br><span class=\"line\">    )</span><br><span class=\"line\">    registration_required = models.BooleanField(_(<span class=\"string\">'registration required'</span>),</span><br><span class=\"line\">        help_text=_(<span class=\"string\">\"If this is checked, only logged-in users will be able to view the page.\"</span>),</span><br><span class=\"line\">        default=<span class=\"keyword\">False</span>)</span><br><span class=\"line\">    sites = models.ManyToManyField(Site)</span><br><span class=\"line\"> </span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Meta</span>:</span></span><br><span class=\"line\">        db_table = <span class=\"string\">'django_flatpage'</span></span><br><span class=\"line\">        verbose_name = _(<span class=\"string\">'flat page'</span>)</span><br><span class=\"line\">        verbose_name_plural = _(<span class=\"string\">'flat pages'</span>)</span><br><span class=\"line\">        ordering = (<span class=\"string\">'url'</span>,)</span><br><span class=\"line\"> </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">__str__</span><span class=\"params\">(self)</span>:</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"string\">\"%s -- %s\"</span> % (self.url, self.title)</span><br><span class=\"line\"> </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">get_absolute_url</span><span class=\"params\">(self)</span>:</span></span><br><span class=\"line\">        <span class=\"comment\"># Handle script prefix manually because we bypass reverse()</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> iri_to_uri(get_script_prefix().rstrip(<span class=\"string\">'/'</span>) + self.url)</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"模板\"><a href=\"#模板\" class=\"headerlink\" title=\"模板\"></a>模板</h2><p>默认模板路径为<code>flatpages/default.html</code><br><figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE html&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span>&#123;&#123; flatpage.title &#125;&#125;<span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\">&#123;&#123; flatpage.content &#125;&#125;</span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p>\n<blockquote>\n<p>在实际应用中，我们不太可能会使用默认的模板，你可能需要自己写一个漂亮模板，比如有一个头部和底部，头部可能还需要添加<code>requeset.user</code>显示用户信息等。</p>\n</blockquote>\n<h2 id=\"高级应用\"><a href=\"#高级应用\" class=\"headerlink\" title=\"高级应用\"></a>高级应用</h2><p>获取<code>flatpages</code>实例列表<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;% load flatpages %&#125;</span><br><span class=\"line\">&#123;% get_flatpages as flatpages %&#125;</span><br></pre></td></tr></table></figure></p>\n<p>获取当前用户能打开的<code>flatpages</code>实例列表<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;% load flatpages %&#125;</span><br><span class=\"line\">&#123;% get_flatpages for request.user as about_pages %&#125;</span><br></pre></td></tr></table></figure></p>\n<p>获取链接以<code>/about/</code>为开头的<code>flatpages</code>实例列表<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;% load flatpages %&#125;</span><br><span class=\"line\">&#123;% get_flatpages &apos;/about/&apos; as about_pages %&#125;</span><br></pre></td></tr></table></figure></p>\n<p>上面两种也可以组合使用<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;% load flatpages %&#125;</span><br><span class=\"line\">&#123;% get_flatpages &apos;/about/&apos; for someuser as about_pages %&#125;</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"生成sitemaps-xml\"><a href=\"#生成sitemaps-xml\" class=\"headerlink\" title=\"生成sitemaps.xml\"></a>生成<code>sitemaps.xml</code></h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">from django.conf.urls import url</span><br><span class=\"line\">from django.contrib.flatpages.sitemaps import FlatPageSitemap</span><br><span class=\"line\">from django.contrib.sitemaps.views import sitemap</span><br><span class=\"line\"> </span><br><span class=\"line\">urlpatterns = [</span><br><span class=\"line\">    # ...</span><br><span class=\"line\"> </span><br><span class=\"line\">    # the sitemap</span><br><span class=\"line\">    url(r&apos;^sitemap\\.xml$&apos;, sitemap,</span><br><span class=\"line\">        &#123;&apos;sitemaps&apos;: &#123;&apos;flatpages&apos;: FlatPageSitemap&#125;&#125;,</span><br><span class=\"line\">        name=&apos;django.contrib.sitemaps.views.sitemap&apos;),</span><br><span class=\"line\">]</span><br></pre></td></tr></table></figure>\n<h2 id=\"容易踩的坑\"><a href=\"#容易踩的坑\" class=\"headerlink\" title=\"容易踩的坑\"></a>容易踩的坑</h2><p>最好把<code>settings.py</code>里的<code>APPEND_SLASH</code>设置为<code>Ture</code>， 这样不管是<code>/about-us</code>还是<code>/about-us/</code>都可以访问到。</p>\n<h2 id=\"参考资料\"><a href=\"#参考资料\" class=\"headerlink\" title=\"参考资料\"></a>参考资料</h2><ul>\n<li><a href=\"https://docs.djangoproject.com/en/1.8/ref/contrib/flatpages/\" target=\"_blank\" rel=\"noopener\">https://docs.djangoproject.com/en/1.8/ref/contrib/flatpages/</a></li>\n<li><a href=\"http://djangobook.py3k.cn/2.0/chapter16/\" target=\"_blank\" rel=\"noopener\">http://djangobook.py3k.cn/2.0/chapter16/</a></li>\n</ul>\n","raw":null,"categories":[{"name":"程序猿","path":"api/categories/程序猿.json"}],"tags":[{"name":"Django","path":"api/tags/Django.json"},{"name":"Python","path":"api/tags/Python.json"}]},{"title":"Django字段选项related_name和related_query_name","slug":"django字段选项related-name和related-query-name","date":"2015-10-20T14:22:06.000Z","updated":"2020-08-15T03:05:59.808Z","comments":true,"path":"api/articles/django字段选项related-name和related-query-name.json","excerpt":"data<br>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>sqlite&gt; select * from author;<br>id      name    age<br>1       jim     12<br>2       tom     11<br>sqlite&gt; select * from book;<br>id      name    author_id<br>1       learn java      1<br>2       learn python    1<br>3       learn c++       2<br>","cover":null,"content":"<p><code>data</code><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sqlite&gt; select * from author;</span><br><span class=\"line\">id      name    age</span><br><span class=\"line\">1       jim     12</span><br><span class=\"line\">2       tom     11</span><br><span class=\"line\">sqlite&gt; select * from book;</span><br><span class=\"line\">id      name    author_id</span><br><span class=\"line\">1       learn java      1</span><br><span class=\"line\">2       learn python    1</span><br><span class=\"line\">3       learn c++       2</span><br></pre></td></tr></table></figure></p>\n<a id=\"more\"></a>\n<p><code>models.py</code><br><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># -*- coding: UTF-8 -*-</span></span><br><span class=\"line\"><span class=\"keyword\">from</span> __future__ <span class=\"keyword\">import</span> unicode_literals</span><br><span class=\"line\"><span class=\"keyword\">from</span> django.db <span class=\"keyword\">import</span> models</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Create your models here.</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Author</span><span class=\"params\">(models.Model)</span>:</span></span><br><span class=\"line\">    name = models.CharField(verbose_name=<span class=\"string\">'姓名'</span>, max_length=<span class=\"number\">50</span>)</span><br><span class=\"line\">    age = models.IntegerField(verbose_name=<span class=\"string\">'年龄'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Book</span><span class=\"params\">(models.Model)</span>:</span></span><br><span class=\"line\">    name = models.CharField(verbose_name=<span class=\"string\">'书名'</span>, max_length=<span class=\"number\">100</span>)</span><br><span class=\"line\">    author = models.ForeignKey(Author, verbose_name=<span class=\"string\">'作者'</span>)</span><br></pre></td></tr></table></figure></p>\n<p>执行语句<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt;&gt;&gt; Author.objects.filter(book__name=&apos;learn java&apos;)</span><br><span class=\"line\">[&lt;Author: jim&gt;]</span><br><span class=\"line\">&gt;&gt;&gt; author = Author.objects.get(pk=1)</span><br><span class=\"line\">&gt;&gt;&gt; author.book_set.all()</span><br><span class=\"line\">[&lt;Book: learn java&gt;, &lt;Book: learn python&gt;]</span><br></pre></td></tr></table></figure></p>\n<p>假如把类<code>Book</code>改成这样<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">class Book(models.Model):</span><br><span class=\"line\">    name = models.CharField(verbose_name=&apos;书名&apos;, max_length=100)</span><br><span class=\"line\">    author = models.ForeignKey(Author, verbose_name=&apos;作者&apos;, related_name=&apos;bs&apos;, related_query_name=&apos;b&apos;)</span><br></pre></td></tr></table></figure></p>\n<p>那么上面查询代码就应该写成这样<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt;&gt;&gt; Author.objects.filter(b__name=&apos;learn java&apos;)</span><br><span class=\"line\">[&lt;Author: jim&gt;]</span><br><span class=\"line\">&gt;&gt;&gt; author = Author.objects.get(pk=1)</span><br><span class=\"line\">&gt;&gt;&gt; author.bs.all()</span><br><span class=\"line\">[&lt;Book: learn java&gt;, &lt;Book: learn python&gt;]</span><br></pre></td></tr></table></figure></p>\n<blockquote>\n<p>如果<code>book</code>表里有两个字段都外键关联<code>author</code>表，这时<code>related_name</code>就非常有用了。</p>\n</blockquote>\n","raw":null,"categories":[{"name":"程序猿","path":"api/categories/程序猿.json"}],"tags":[{"name":"Django","path":"api/tags/Django.json"},{"name":"Python","path":"api/tags/Python.json"}]},{"title":"pip常用命令","slug":"pip常用命令","date":"2015-01-01T15:38:56.000Z","updated":"2020-12-16T13:14:20.701Z","comments":true,"path":"api/articles/pip常用命令.json","excerpt":"列出已安装的包pip freeze or pip list","cover":null,"content":"<h2 id=\"列出已安装的包\"><a href=\"#列出已安装的包\" class=\"headerlink\" title=\"列出已安装的包\"></a>列出已安装的包</h2><p><code>pip freeze</code> or <code>pip list</code></p>\n<a id=\"more\"></a>\n<h3 id=\"导出requirements-txt\"><a href=\"#导出requirements-txt\" class=\"headerlink\" title=\"导出requirements.txt\"></a>导出requirements.txt</h3><p><code>pip freeze &gt; &lt;目录&gt;/requirements.txt</code></p>\n<h2 id=\"安装包\"><a href=\"#安装包\" class=\"headerlink\" title=\"安装包\"></a>安装包</h2><h3 id=\"在线安装\"><a href=\"#在线安装\" class=\"headerlink\" title=\"在线安装\"></a>在线安装</h3><p><code>pip install &lt;包名&gt;</code> 或 <code>pip install -r requirements.txt</code></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 安装1.9版本的django</span><br><span class=\"line\">pip install django==1.9</span><br><span class=\"line\"># 安装版本号大于1.9的django，注意有引号</span><br><span class=\"line\">pip install &quot;django&gt;1.9&quot;</span><br><span class=\"line\">pip install &quot;django&gt;=1.9&quot;</span><br><span class=\"line\">pip install &quot;django&lt;1.9&quot;</span><br><span class=\"line\">pip install &quot;django&lt;=1.9&quot;</span><br><span class=\"line\">pip install &quot;django&gt;&lt;1.9&quot;</span><br></pre></td></tr></table></figure>\n<p>requirements.txt内容格式为：</p>\n<pre><code>APScheduler==2.1.2\nDjango==1.5.4\nMySQL-Connector-Python==2.0.1\nMySQL-python==1.2.3\nPIL==1.1.7\nSouth==1.0.2\ndjango-grappelli==2.6.3\ndjango-pagination==1.0.7\n</code></pre><h3 id=\"安装本地安装包\"><a href=\"#安装本地安装包\" class=\"headerlink\" title=\"安装本地安装包\"></a>安装本地安装包</h3><p><code>pip install &lt;目录&gt;/&lt;文件名&gt;</code> 或 <code>pip install --use-wheel --no-index --find-links=wheelhouse/ &lt;包名&gt;</code></p>\n<p><em>&lt;包名&gt;前有空格</em></p>\n<p>可简写为</p>\n<p><code>pip install --no-index -f=&lt;目录&gt;/ &lt;包名&gt;</code></p>\n<h3 id=\"卸载包\"><a href=\"#卸载包\" class=\"headerlink\" title=\"卸载包\"></a>卸载包</h3><p><code>pip uninstall &lt;包名&gt;</code> 或 <code>pip uninstall -r requirements.txt</code></p>\n<h3 id=\"升级包\"><a href=\"#升级包\" class=\"headerlink\" title=\"升级包\"></a>升级包</h3><p><code>pip install -U &lt;包名&gt;</code></p>\n<h3 id=\"升级pip\"><a href=\"#升级pip\" class=\"headerlink\" title=\"升级pip\"></a>升级pip</h3><p><code>pip install -U pip</code></p>\n<h2 id=\"显示包所在的目录\"><a href=\"#显示包所在的目录\" class=\"headerlink\" title=\"显示包所在的目录\"></a>显示包所在的目录</h2><p><code>pip show -f &lt;包名&gt;</code></p>\n<h2 id=\"搜索包\"><a href=\"#搜索包\" class=\"headerlink\" title=\"搜索包\"></a>搜索包</h2><p><code>pip search &lt;搜索关键字&gt;</code></p>\n<h2 id=\"查询可升级的包\"><a href=\"#查询可升级的包\" class=\"headerlink\" title=\"查询可升级的包\"></a>查询可升级的包</h2><p><code>pip list -o</code></p>\n<h2 id=\"下载包而不安装\"><a href=\"#下载包而不安装\" class=\"headerlink\" title=\"下载包而不安装\"></a>下载包而不安装</h2><p> <code>pip install &lt;包名&gt; -d  &lt;目录&gt;</code> 或 <code>pip install -d &lt;目录&gt; -r requirements.txt</code></p>\n<h2 id=\"打包\"><a href=\"#打包\" class=\"headerlink\" title=\"打包\"></a>打包</h2><p><code>pip wheel &lt;包名&gt;</code></p>\n<h2 id=\"更换国内pypi镜像\"><a href=\"#更换国内pypi镜像\" class=\"headerlink\" title=\"更换国内pypi镜像\"></a>更换国内pypi镜像</h2><h3 id=\"国内pypi镜像\"><a href=\"#国内pypi镜像\" class=\"headerlink\" title=\"国内pypi镜像\"></a>国内pypi镜像</h3><ul>\n<li>阿里云 <a href=\"https://mirrors.aliyun.com/pypi/simple/\" target=\"_blank\" rel=\"noopener\">https://mirrors.aliyun.com/pypi/simple/</a></li>\n<li>豆瓣：<a href=\"https://pypi.douban.com/simple\" target=\"_blank\" rel=\"noopener\">https://pypi.douban.com/simple</a></li>\n<li>中国科学技术大学：<a href=\"https://mirrors.ustc.edu.cn/pypi/web/simple/\" target=\"_blank\" rel=\"noopener\">https://mirrors.ustc.edu.cn/pypi/web/simple/</a></li>\n<li>清华大学TUNA：<a href=\"https://pypi.tuna.tsinghua.edu.cn/simple\" target=\"_blank\" rel=\"noopener\">https://pypi.tuna.tsinghua.edu.cn/simple</a><br><a href=\"https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple/\" target=\"_blank\" rel=\"noopener\">https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple/</a></li>\n</ul>\n<h3 id=\"指定单次安装源\"><a href=\"#指定单次安装源\" class=\"headerlink\" title=\"指定单次安装源\"></a>指定单次安装源</h3><p><code>pip install &lt;包名&gt; -i http://pypi.v2ex.com/simple</code></p>\n<h3 id=\"指定全局安装源\"><a href=\"#指定全局安装源\" class=\"headerlink\" title=\"指定全局安装源\"></a>指定全局安装源</h3><p>在unix和macos，配置文件为：$HOME/.pip/pip.conf<br>在windows上，配置文件为：%HOME%\\pip\\pip.ini </p>\n<pre><code>[global]\ntimeout = 6000\nindex-url = http://pypi.douban.com/simple\n</code></pre><hr>\n<h2 id=\"参考资料\"><a href=\"#参考资料\" class=\"headerlink\" title=\"参考资料\"></a>参考资料</h2><blockquote>\n<p><a href=\"https://pip.pypa.io/en/latest/\" target=\"_blank\" rel=\"noopener\">pip documentation</a></p>\n</blockquote>\n","raw":null,"categories":[{"name":"程序猿","path":"api/categories/程序猿.json"}],"tags":[{"name":"命令","path":"api/tags/命令.json"},{"name":"教程","path":"api/tags/教程.json"},{"name":"Python","path":"api/tags/Python.json"},{"name":"pip","path":"api/tags/pip.json"}]},{"title":"python中的UUID","slug":"python中的UUID","date":"2015-06-02T15:32:59.000Z","updated":"2020-08-15T03:07:16.864Z","comments":true,"path":"api/articles/python中的UUID.json","excerpt":"简介（维基百科）通用唯一识别码（英语：Universally Unique Identifier，简称UUID）是一种软件建构的标准，亦为开放软件基金会组织在分散式计算环境领域的一部份。<br>UUID的目的，是让分散式系统中的所有元素，都能有唯一的辨识资讯，而不需要透过中央控制端来做辨识资讯的指定。如此一来，每个人都可以建立不与其它人冲突的UUID。在这样的情况下，就不需考虑资料库建立时的名称重复问题。目前最广泛应用的UUID，是微软公司的全局唯一标识符（GUID），而其他重要的应用，则有Linux ext2/ext3档案系统、LUKS加密分区、GNOME、KDE、Mac OS X等等。另外我们也可以在e2fsprogs套件中的UUID函式库找到实现。[3]","cover":null,"content":"<h2 id=\"简介（维基百科）\"><a href=\"#简介（维基百科）\" class=\"headerlink\" title=\"简介（维基百科）\"></a>简介（维基百科）</h2><blockquote>\n<p>通用唯一识别码（英语：Universally Unique Identifier，简称UUID）是一种软件建构的标准，亦为开放软件基金会组织在分散式计算环境领域的一部份。<br>UUID的目的，是让分散式系统中的所有元素，都能有唯一的辨识资讯，而不需要透过中央控制端来做辨识资讯的指定。如此一来，每个人都可以建立不与其它人冲突的UUID。在这样的情况下，就不需考虑资料库建立时的名称重复问题。目前最广泛应用的UUID，是微软公司的全局唯一标识符（GUID），而其他重要的应用，则有Linux ext2/ext3档案系统、LUKS加密分区、GNOME、KDE、Mac OS X等等。另外我们也可以在e2fsprogs套件中的UUID函式库找到实现。<a href=\"http://zh.wikipedia.org/zh-hans/%E9%80%9A%E7%94%A8%E5%94%AF%E4%B8%80%E8%AF%86%E5%88%AB%E7%A0%81\" title=\"通用唯一识别码\" target=\"_blank\" rel=\"noopener\">[3]</a></p>\n</blockquote>\n<a id=\"more\"></a>\n<h2 id=\"定义\"><a href=\"#定义\" class=\"headerlink\" title=\"定义 :\"></a>定义 :</h2><p>UUID是由一组32位数的16进位数字所构成，是故UUID理论上的总数为1632=2128，约等于3.4 x 1038。也就是说若每纳秒产生1兆个UUID，要花100亿年才会将所有UUID用完，，它保证对在同一时空中的所有机器都是唯一的（重复机率请参考<a href=\"http://zh.wikipedia.org/zh-hans/%E9%80%9A%E7%94%A8%E5%94%AF%E4%B8%80%E8%AF%86%E5%88%AB%E7%A0%81\" target=\"_blank\" rel=\"noopener\">随机UUID的重复机率</a>）。</p>\n<h2 id=\"算法\"><a href=\"#算法\" class=\"headerlink\" title=\"算法\"></a>算法</h2><ol>\n<li>uuid1()——基于时间戳<br>由MAC地址、当前时间戳、随机数生成。可以保证全球范围内的唯一性，<br>但MAC的使用同时带来安全性问题，局域网中可以使用IP来代替MAC。</li>\n<li>uuid2()——基于分布式计算环境DCE（Python中没有这个函数）<br>算法与uuid1相同，不同的是把时间戳的前4位置换为POSIX的UID。<br>实际中很少用到该方法。</li>\n<li>uuid3()——基于名字的MD5散列值<br>通过计算名字和命名空间的MD5散列值得到，保证了同一命名空间中不同名字的唯一性，<br>和不同命名空间的唯一性，但同一命名空间的同一名字生成相同的uuid。</li>\n<li>uuid4()——基于随机数<br>由伪随机数得到，有一定的重复概率，该概率可以计算出来。</li>\n<li>uuid5()——基于名字的SHA-1散列值<br>算法与uuid3相同，不同的是使用 Secure Hash Algorithm 1 算法</li>\n</ol>\n<h2 id=\"在python中在生成UUID\"><a href=\"#在python中在生成UUID\" class=\"headerlink\" title=\"在python中在生成UUID\"></a>在<code>python</code>中在生成UUID</h2><p><code>import uuid</code>后即可使用<br>示例代码<br><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> uuid</span><br><span class=\"line\">uuid.uuid1()</span><br><span class=\"line\">uuid.uuid3(namespace, name)</span><br><span class=\"line\">uuid.uuid4()</span><br><span class=\"line\">uuid.uuid5(namespace, name)</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><blockquote>\n<p><a href=\"http://zh.wikipedia.org/zh-hans/%E9%80%9A%E7%94%A8%E5%94%AF%E4%B8%80%E8%AF%86%E5%88%AB%E7%A0%81\" target=\"_blank\" rel=\"noopener\">http://zh.wikipedia.org/zh-hans/%E9%80%9A%E7%94%A8%E5%94%AF%E4%B8%80%E8%AF%86%E5%88%AB%E7%A0%81</a><br><a href=\"https://docs.python.org/2/library/uuid.html\" target=\"_blank\" rel=\"noopener\">https://docs.python.org/2/library/uuid.html</a></p>\n</blockquote>\n","raw":null,"categories":[{"name":"程序猿","path":"api/categories/程序猿.json"}],"tags":[{"name":"Python","path":"api/tags/Python.json"},{"name":"UUID","path":"api/tags/UUID.json"}]},{"title":"使用alembic进行数据库版本管理","slug":"使用alembic进行数据库版本管理","date":"2018-09-13T10:53:14.000Z","updated":"2020-03-04T05:22:29.004Z","comments":true,"path":"api/articles/使用alembic进行数据库版本管理.json","excerpt":"转自：https://www.cnblogs.com/blackmatrix/p/6236573.html，做了部分修改前言随着项目业务需求的不断变更，数据库的表结构修改难以避免，此时就需要对数据库的修改加以记录和控制，便于项目的版本管理和随意的升级和降级。Alembic 就可以很好的解决这个问题。Alembic 是 SQLAlchemy 作者开发的 Python 数据库版本管理工具。<br>","cover":null,"content":"<p>转自：<a href=\"https://www.cnblogs.com/blackmatrix/p/6236573.html，做了部分修改\" target=\"_blank\" rel=\"noopener\">https://www.cnblogs.com/blackmatrix/p/6236573.html，做了部分修改</a></p>\n<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>随着项目业务需求的不断变更，数据库的表结构修改难以避免，此时就需要对数据库的修改加以记录和控制，便于项目的版本管理和随意的升级和降级。</p>\n<p>Alembic 就可以很好的解决这个问题。Alembic 是 SQLAlchemy 作者开发的 Python 数据库版本管理工具。<br><a id=\"more\"></a></p>\n<h2 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pip install alembic</span><br></pre></td></tr></table></figure>\n<p>通过 pip 命令安装，如果使用虚拟环境，记得激活虚拟环境后再执行 pip 命令</p>\n<p>同时需要安装的还有 SQLAlchemy 和 PyMysql</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pip install sqlalchemy</span><br><span class=\"line\">pip install pymysql</span><br></pre></td></tr></table></figure>\n<h2 id=\"初始化\"><a href=\"#初始化\" class=\"headerlink\" title=\"初始化\"></a>初始化</h2><p>在使用 alembic 之前，需要进行初始化操作。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">alembic init &lt;YOUR_ALEMBIC_DIR&gt;</span><br></pre></td></tr></table></figure>\n<p>YOUR_ALEMBIC_DIR，可以取一个符合项目名称规范的目录名，如</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">alembic init alembic</span><br></pre></td></tr></table></figure>\n<p><strong>此时需要注意，如果之前是在虚拟环境中安装的 alembic，需要激活虚拟环境后，在执行上述命令。</strong></p>\n<p><strong>同时，建议 cd 到项目根目录再执行初始化操作，因为 YOUR_ALEMBIC_DIR 会在当前目录下创建。</strong></p>\n<p>显示类似结果即初始化成功。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Creating directory D:\\Project\\py_sqlalchemy_demo\\alembic ... <span class=\"keyword\">done</span></span><br><span class=\"line\">Creating directory D:\\Project\\py_sqlalchemy_demo\\alembic\\versions ... <span class=\"keyword\">done</span></span><br><span class=\"line\">Generating D:\\Project\\py_sqlalchemy_demo\\alembic.ini ... <span class=\"keyword\">done</span></span><br><span class=\"line\">Generating D:\\Project\\py_sqlalchemy_demo\\alembic\\env.py ... <span class=\"keyword\">done</span></span><br><span class=\"line\">Generating D:\\Project\\py_sqlalchemy_demo\\alembic\\README ... <span class=\"keyword\">done</span></span><br><span class=\"line\">Generating D:\\Project\\py_sqlalchemy_demo\\alembic\\script.py.mako ... <span class=\"keyword\">done</span></span><br><span class=\"line\">Please edit configuration/connection/logging settings <span class=\"keyword\">in</span> <span class=\"string\">'D:\\\\Project\\\\py_sqlalchemy_demo\\\\alembic.ini'</span> befor</span><br><span class=\"line\">e proceeding.</span><br></pre></td></tr></table></figure>\n<p>初始化成功后，会在执行初始化命令的目录下，生成一个 alembic.ini 的配置文件，及一个 alembic 目录，目录名就是之前设置的 YOUR_ALEMBIC_DIR。</p>\n<h2 id=\"修改配置文件\"><a href=\"#修改配置文件\" class=\"headerlink\" title=\"修改配置文件\"></a>修改配置文件</h2><p>接下来对 alembic.ini 的信息进行修改。</p>\n<p>主要修改的是配置文件中的数据库连接部分。</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sqlalchemy.url = driver://user:<span class=\"keyword\">pass</span>@localhost:port/dbname</span><br></pre></td></tr></table></figure>\n<p>将配置文件中，此部分替换成对应的数据库连接，这个数据库连接的写法是与 SQLAlchemy 创建 engine 时是一样的。</p>\n<p>如我在 demo 中使用的是 SQLAlchemy 与 PyMysql，那数据库连接就是类似如下</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql+pymysql://demo_user:demo123456@<span class=\"number\">127.0</span><span class=\"number\">.0</span><span class=\"number\">.1</span>:<span class=\"number\">3306</span>/demo_db</span><br></pre></td></tr></table></figure>\n<h2 id=\"修改-env-py\"><a href=\"#修改-env-py\" class=\"headerlink\" title=\"修改 env.py\"></a>修改 env.py</h2><p>除修改配置文件外，还需要对 YOUR_ALEMBIC_DIR 目录下的 env.py 文件进行修改。</p>\n<p>在 env.py 中，将 target_metadata 设置成项目的 model，使 alembic 能获取到项目中 model 定义的信息。</p>\n<p>将原先的</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">target_metadata = <span class=\"keyword\">None</span></span><br></pre></td></tr></table></figure>\n<p>修改成项目中的 model<br><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> os</span><br><span class=\"line\"><span class=\"keyword\">import</span> sys</span><br><span class=\"line\"></span><br><span class=\"line\">sys.path.append(dirname(dirname(abspath(__file__))))</span><br><span class=\"line\"><span class=\"keyword\">from</span> app <span class=\"keyword\">import</span> db</span><br><span class=\"line\">target_metadata = db.metadata</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"创建新版本\"><a href=\"#创建新版本\" class=\"headerlink\" title=\"创建新版本\"></a>创建新版本</h2><p>用 alembic revision -m + 注释 创建数据库版本</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">alembic revision --autogenerate -m <span class=\"string\">\"init db\"</span></span><br></pre></td></tr></table></figure>\n<p>运行后，类似如下结果，即创建版本成功</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">INFO  [alembic.runtime.migration] Context impl MySQLImpl.</span><br><span class=\"line\">INFO  [alembic.runtime.migration] Will assume non-transactional DDL.</span><br><span class=\"line\">INFO  [alembic.autogenerate.compare] Detected removed table <span class=\"string\">'user'</span></span><br><span class=\"line\">Generating D:\\Project\\py_sqlalchemy_demo\\alembic\\versions\\7b55b3d83158_create_tables.py ... <span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n<p>每次修改过 SQLAlchemy 的 model，执行此命令即可创建对应的版本。</p>\n<p>执行成功后，会在项目根目录下的 alembic/versions / 下生成的对应版本的 py 文件。命令规则是版本号 + 注释。(这个命名规则是在配置文件中定义的)</p>\n<p>在每次创建新版本后，需要执行将数据库升级到新版本的命令，才能继续更新版本。</p>\n<h2 id=\"变更数据库\"><a href=\"#变更数据库\" class=\"headerlink\" title=\"变更数据库\"></a>变更数据库</h2><p>在每次创建新版本后，需要执行将数据库升级到新版本的命令，才能继续更新版本</p>\n<p><strong>将数据库升级到最新版本</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">alembic upgrade head</span><br></pre></td></tr></table></figure>\n<p>运行结果类似</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">(venv_win) D:\\Project\\py_sqlalchemy_demo&gt;alembic upgrade head</span><br><span class=\"line\">INFO  [alembic.runtime.migration] Context impl MySQLImpl.</span><br><span class=\"line\">INFO  [alembic.runtime.migration] Will assume non-transactional DDL.</span><br><span class=\"line\">INFO  [alembic.runtime.migration] Running upgrade 7b55b3d83158 -&gt; b034414f04cd, create tables02</span><br></pre></td></tr></table></figure>\n<p>其中，命令中的 head 和 base 特指最新版本和最初版本。当需要对数据库进行升级时，使用 upgrade，降级使用 downgrade。</p>\n<p><strong>将数据库降级到最初版本</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">alembic downgrade base</span><br></pre></td></tr></table></figure>\n<p><strong>将数据库降级到执行版本</strong>，使用 alembic downgrade + 版本号，不包含注释部分</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">alembic downgrade &lt;version&gt;</span><br></pre></td></tr></table></figure>\n<p>如</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">alembic downgrade 7b55b3d83158</span><br></pre></td></tr></table></figure>\n<p>运行结果</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">INFO  [alembic.runtime.migration] Context impl MySQLImpl.</span><br><span class=\"line\">INFO  [alembic.runtime.migration] Will assume non-transactional DDL.</span><br><span class=\"line\">INFO  [alembic.runtime.migration] Running downgrade b034414f04cd -&gt; 7b55b3d83158, create tables02</span><br></pre></td></tr></table></figure>\n<p>升级也是同样的道理，alembic upgrade + 版本号</p>\n<h2 id=\"离线更新（生成-sql-脚本）\"><a href=\"#离线更新（生成-sql-脚本）\" class=\"headerlink\" title=\"离线更新（生成 sql 脚本）\"></a>离线更新（生成 sql 脚本）</h2><p>在某些不适合在线更新的情况，可以采用生成 sql 脚本的形式，进行离线更新：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">alembic upgrade &lt;version&gt; --sql &gt; migration.sql</span><br></pre></td></tr></table></figure>\n<p>如：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">alembic upgrade ae1027a6acf --sql &gt; migration.sql</span><br></pre></td></tr></table></figure>\n<p>从特定起始版本生成 sql 脚本：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">alembic upgrade &lt;vsersion&gt;:&lt;vsersion&gt; --sql &gt; migration.sql</span><br></pre></td></tr></table></figure>\n<p>如：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">alembic upgrade 1975ea83b712:ae1027a6acf --sql &gt; migration.sql</span><br></pre></td></tr></table></figure>\n<p>如果是数据库降级操作，把 upgrade 替换为 downgrade。</p>\n<h2 id=\"查询当前数据库版本号\"><a href=\"#查询当前数据库版本号\" class=\"headerlink\" title=\"查询当前数据库版本号\"></a>查询当前数据库版本号</h2><p>在对数据库进行升级或降级后，会在当前操作的数据库中新增一个表；alembic_version。</p>\n<p>表中的 version_num 字段记录了当前的数据库版本号。</p>\n<h2 id=\"清除所有版本\"><a href=\"#清除所有版本\" class=\"headerlink\" title=\"清除所有版本\"></a>清除所有版本</h2><p>如果需要清除所有的版本，将 versions 删除掉，同时删除数据库的 alembic_version 表。</p>\n<h2 id=\"参考资料\"><a href=\"#参考资料\" class=\"headerlink\" title=\"参考资料\"></a>参考资料</h2><p><a href=\"http://alembic.zzzcomputing.com/en/latest/tutorial.html\" target=\"_blank\" rel=\"noopener\">http://alembic.zzzcomputing.com/en/latest/tutorial.html</a></p>\n<p><a href=\"http://www.codeweblog.com/%25E5%25B8%25B8%25E8%25A7%2581%25E7%259A%2584sqlalchemy%25E5%2588%2597%25E7%25B1%25BB%25E5%259E%258B-%25E9%2585%258D%25E7%25BD%25AE%25E9%2580%2589%25E9%25A1%25B9%25E5%2592%258C%25E5%2585%25B3%25E7%25B3%25BB%25E9%2580%2589%25E9%25A1%25B9/\" target=\"_blank\" rel=\"noopener\">http://www.codeweblog.com/%E5%B8%B8%E8%A7%81%E7%9A%84sqlalchemy%E5%88%97%E7%B1%BB%E5%9E%8B-%E9%85%8D%E7%BD%AE%E9%80%89%E9%A1%B9%E5%92%8C%E5%85%B3%E7%B3%BB%E9%80%89%E9%A1%B9/</a></p>\n<p><a href=\"http://blog.csdn.net/wenxuansoft/article/details/50242957\" target=\"_blank\" rel=\"noopener\">http://blog.csdn.net/wenxuansoft/article/details/50242957</a></p>\n","raw":null,"categories":[{"name":"程序猿","path":"api/categories/程序猿.json"}],"tags":[{"name":"教程","path":"api/tags/教程.json"},{"name":"Python","path":"api/tags/Python.json"}]},{"title":"使用Virtualenv创建独立的Python运行环境","slug":"使用virtualenv创建独立的python运行环境","date":"2015-01-01T12:39:14.000Z","updated":"2020-08-15T03:02:19.564Z","comments":true,"path":"api/articles/使用virtualenv创建独立的python运行环境.json","excerpt":"准备工作python环境pip安装1<br>pip install virtualenv<br>或<br>1<br>pip install https://github.com/pypa/virtualenv/tarball/develop<br>","cover":null,"content":"<h2 id=\"准备工作\"><a href=\"#准备工作\" class=\"headerlink\" title=\"准备工作\"></a>准备工作</h2><ul>\n<li>python环境</li>\n<li>pip</li>\n</ul>\n<h2 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pip install virtualenv</span><br></pre></td></tr></table></figure>\n<p>或<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pip install https://github.com/pypa/virtualenv/tarball/develop</span><br></pre></td></tr></table></figure></p>\n<a id=\"more\"></a>\n<h2 id=\"创建虚拟环境\"><a href=\"#创建虚拟环境\" class=\"headerlink\" title=\"创建虚拟环境\"></a>创建虚拟环境</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">virtualenv myVE</span><br></pre></td></tr></table></figure>\n<p>指定python解释器</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-p PYTHON_EXE, --python=PYTHON_EXE</span><br></pre></td></tr></table></figure>\n<p><em>创建虚拟环境时默认会自动安装setuptools和pip</em></p>\n<p>不安装setuptool</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">--no--setuptools</span><br></pre></td></tr></table></figure>\n<p>不安装pip</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">--no--pip</span><br></pre></td></tr></table></figure>\n<p><em>更多Options请参考<a href=\"https://virtualenv.pypa.io/en/latest/reference.html\" target=\"_blank\" rel=\"noopener\">官方文档</a></em> </p>\n<h2 id=\"启动虚拟环境\"><a href=\"#启动虚拟环境\" class=\"headerlink\" title=\"启动虚拟环境\"></a>启动虚拟环境</h2><p> Mac OS</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cd myVE</span><br><span class=\"line\">source ./bin/activate</span><br></pre></td></tr></table></figure>\n<p>Windows</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cd myVE</span><br><span class=\"line\">scripts\\activate</span><br></pre></td></tr></table></figure>\n<p>启动成功后可以在开头显示”(myVE)”，说明已经进入刚刚创建的虚拟环境了</p>\n<h2 id=\"退出\"><a href=\"#退出\" class=\"headerlink\" title=\"退出\"></a>退出</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">deactivate</span><br></pre></td></tr></table></figure>\n<h2 id=\"virtualenvwrapper\"><a href=\"#virtualenvwrapper\" class=\"headerlink\" title=\"virtualenvwrapper\"></a>virtualenvwrapper</h2><h3 id=\"安装-1\"><a href=\"#安装-1\" class=\"headerlink\" title=\"安装\"></a>安装</h3><blockquote>\n<p>Virtaulenvwrapper是virtualenv的扩展包，用于更方便管理虚拟环境，它可以做：</p>\n<ol>\n<li>将所有虚拟环境整合在一个目录下</li>\n<li>管理（新增，删除，复制）虚拟环境</li>\n<li>切换虚拟环境</li>\n</ol>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pip install virtualenvwrapper</span><br></pre></td></tr></table></figure>\n<p>Windows下还需额外安装virtualenvwrapper-win<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pip install virtualenvwrapper-win</span><br></pre></td></tr></table></figure></p>\n<p>ubuntu需要将下面这句加入到<code>~/.bashrc</code>里面<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">if [ -f /usr/local/bin/virtualenvwrapper.sh ]; then</span><br><span class=\"line\">    source /usr/local/bin/virtualenvwrapper.sh</span><br><span class=\"line\">fi</span><br></pre></td></tr></table></figure></p>\n<p>加入后需要重启才能生效，如果想要立即生效，输入命令<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">source ~/.bashrc</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"常用命令\"><a href=\"#常用命令\" class=\"headerlink\" title=\"常用命令\"></a>常用命令</h3><p><em>部分命令在windows下无效</em></p>\n<ul>\n<li><code>workon myEnv</code>: 切换虚拟环境</li>\n<li><code>mkvirtualenv</code>: 新建工作环境</li>\n<li><code>rmvirtualenv</code>: 删除工作环境</li>\n<li><code>cdproject</code>: 切换到工程目录</li>\n<li><code>workon</code>/<code>lsvirtualenv</code>: 列出所有虚拟环境</li>\n<li><code>deactivate</code>: 退出虚拟环境</li>\n<li><code>cpvirtualenv [source] [dest]</code> 复制一份虚拟环境。</li>\n<li><code>cdvirtualenv [subdir]</code> 把当前工作目录设置为所在的环境目录。</li>\n<li><code>cdsitepackages [subdir]</code> 把当前工作目录设置为所在环境的sitepackages路径。</li>\n<li><code>add2virtualenv [dir] [dir]</code> 把指定的目录加入当前使用的环境的path中，这常使用于在多个project里面同时使用一个较大的库的情况。</li>\n<li><code>toggleglobalsitepackages -q</code> 控制当前的环境是否使用全局的sitepackages目录。</li>\n</ul>\n<hr>\n<h2 id=\"参考资料\"><a href=\"#参考资料\" class=\"headerlink\" title=\"参考资料\"></a>参考资料</h2><p><a href=\"https://virtualenv.pypa.io/en/latest/\" target=\"_blank\" rel=\"noopener\">https://virtualenv.pypa.io/en/latest/</a></p>\n<p><a href=\"http://virtualenvwrapper.readthedocs.org/en/latest/\" target=\"_blank\" rel=\"noopener\">http://virtualenvwrapper.readthedocs.org/en/latest/</a></p>\n<p><a href=\"https://github.com/davidmarble/virtualenvwrapper-win\" target=\"_blank\" rel=\"noopener\">https://github.com/davidmarble/virtualenvwrapper-win</a></p>\n","raw":null,"categories":[{"name":"程序猿","path":"api/categories/程序猿.json"}],"tags":[{"name":"Python","path":"api/tags/Python.json"},{"name":"Virtualenv","path":"api/tags/Virtualenv.json"},{"name":"virtualenvwrapper","path":"api/tags/virtualenvwrapper.json"},{"name":"独立","path":"api/tags/独立.json"},{"name":"虚拟环境","path":"api/tags/虚拟环境.json"},{"name":"requirements","path":"api/tags/requirements.json"}]},{"title":"代码托管平台码云(Gitee)到Gitea迁移记","slug":"Gitee2Gitea","date":"2020-03-01T11:42:34.000Z","updated":"2020-03-24T06:15:27.492Z","comments":true,"path":"api/articles/Gitee2Gitea.json","excerpt":"团队的代码托管管理平台之前一直用Gitee的企业版本，但除了代码pull/push操作外，基本不用平台上其它功能，除了要新建一个仓库要打开下网页版，其它时间基本不会访问网页版本，所以经过半天的调研，从GitLab/Gogs/Gitea中选择了Gitea，把迁移过程记录如下。","cover":null,"content":"<p>团队的代码托管管理平台之前一直用Gitee的企业版本，但除了代码pull/push操作外，基本不用平台上其它功能，除了要新建一个仓库要打开下网页版，其它时间基本不会访问网页版本，所以经过半天的调研，从GitLab/Gogs/Gitea中选择了Gitea，把迁移过程记录如下。</p>\n<a id=\"more\"></a>\n<h3 id=\"安装Gitea\"><a href=\"#安装Gitea\" class=\"headerlink\" title=\"安装Gitea\"></a>安装Gitea</h3><p>因为服务器上刚好装有docker，按照<a href=\"https://docs.gitea.io/zh-cn/install-with-docker/\" target=\"_blank\" rel=\"noopener\">官方文档</a>选择了最简单的docker安装。</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker pull gitea/gitea:latest</span><br><span class=\"line\">sudo mkdir -p /data/gitea</span><br><span class=\"line\">docker run -d --name=gitea -p 10022:22 -p 10080:3000 -v /data/gitea:/data gitea/gitea:latest</span><br><span class=\"line\">// 重启gitea</span><br><span class=\"line\">docker restart gitea</span><br></pre></td></tr></table></figure>\n<p>安装完成后遇到了页面有三个静态文件（css/js）加载不成功，导致页面排版混乱，F12查看控制台报错net::ERR_CONTENT_LENGTH_MISMATCH，google之，找到这篇文章</p>\n<p><a href=\"https://github.com/xhlwill/blog/issues/17\" target=\"_blank\" rel=\"noopener\">Nginx 做代理时浏览器报错 net::ERR_CONTENT_LENGTH_MISMATCH</a>，按照此方法解决。</p>\n<h3 id=\"配置Nginx\"><a href=\"#配置Nginx\" class=\"headerlink\" title=\"配置Nginx\"></a>配置Nginx</h3><p>在服务器Nginx上配置反向代理</p>\n<p>vi /etc/nginx/conf.d/gitea.conf</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">upstream gitea &#123;</span><br><span class=\"line\">    server 127.0.0.1:10080;</span><br><span class=\"line\">    keepalive 2000;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">    listen       80;</span><br><span class=\"line\">    server_name  git.i.example.com;</span><br><span class=\"line\">    client_max_body_size 1024M;</span><br><span class=\"line\"></span><br><span class=\"line\">    location / &#123;</span><br><span class=\"line\">        proxy_pass http://gitea/;</span><br><span class=\"line\">        proxy_set_header Host $host:$server_port;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>重新加载配置</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo nginx -s reload</span><br></pre></td></tr></table></figure>\n<h3 id=\"域名解析\"><a href=\"#域名解析\" class=\"headerlink\" title=\"域名解析\"></a>域名解析</h3><p>git.i.example.com解析到当前服务器ip，并把服务器防火墙入方向的10022 tcp端口打开，以便使用ssh方式clone仓库时使用。</p>\n<h3 id=\"Gitea初始化\"><a href=\"#Gitea初始化\" class=\"headerlink\" title=\"Gitea初始化\"></a>Gitea初始化</h3><p>打开http://.i.example.com，进入初始化界面（如果没进随便点注册或登录就会进），除了数据库根据需要配置，几个域名和网址要修改下，邮箱和其它选项按需配置。以后如果想修改配置，可以直接修改/data/gitea/gitea/conf/app.ini文件<a href=\"https://docs.gitea.io/zh-cn/config-cheat-sheet/\" target=\"_blank\" rel=\"noopener\">配置说明</a>，修改完成后重启下gitea即可生效。</p>\n<h3 id=\"仓库迁移\"><a href=\"#仓库迁移\" class=\"headerlink\" title=\"仓库迁移\"></a>仓库迁移</h3><p>因为我迁移的是团队项目，所以先通过Gitea提供的API把所有仓库以镜像方式（镜像方式同步过来仓库对成员为只读，并且可以设置间隔时间，默认8小时，定时从原始地址Gitee同步最新代码）同步过来<strong>[操作1]</strong>，然后为每个项目配置好协作者/团队/权限等设置，在这期间，团队成员还是往Gitee上提交代码，待全部设置完成后取消告知团队成员不要往Gitee提交代码，并调用Giea api把所有仓库从Gitee上同步一下最新代码<strong>[操作2]</strong>，然后每个仓库从镜像仓库转为普通仓库，并让团队的所有在自己仓库根目录执行修改本地仓库Git远程仓库地址替换操作<strong>[操作3]</strong></p>\n<p><strong>[操作1]</strong>：登录Gitea后，界面右上角有一个加号，点开了后有一个迁移外部仓库的功能，只要填入外部仓库URL，授权验证信息等信息就可以一键把外部仓库的所有代码（包括所有branch和commit）迁移到Gitea，如果要迁移的仓库比较多，可以使用Gitea提供的Api来操作。对应此迁移操作的api是</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST /repos/migrate?access_token=&lt;your gitea admin access token&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">Request body</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    description: MigrateRepoForm form for migrating repository</span><br><span class=\"line\">    auth_password: string</span><br><span class=\"line\">    auth_username: string</span><br><span class=\"line\">    clone_addr*: string</span><br><span class=\"line\">    description: string</span><br><span class=\"line\">    issues: boolean</span><br><span class=\"line\">    labels: boolean</span><br><span class=\"line\">    milestones: boolean</span><br><span class=\"line\">    mirror: boolean</span><br><span class=\"line\">    private: boolean</span><br><span class=\"line\">    pull_requests: boolean</span><br><span class=\"line\">    releases: boolean</span><br><span class=\"line\">    repo_name*: string</span><br><span class=\"line\">    uid*: integer($int64)</span><br><span class=\"line\">    wiki: boolean</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><strong><em>注：</em></strong></p>\n<ol>\n<li><p>access_token 请在有管理员权限的账号的设置&gt;应用中创建；</p>\n</li>\n<li><p>Request body 中的uid即管理后台&gt;账户管理/组织管理中的ID列值；</p>\n</li>\n</ol>\n<p>找了Gitee没找到可以获取账户下所有仓库信息的API，所以只好手写了一个Gitee仓库地址的文件，类似</p>\n<p>vi gitee-url.txt</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">https://gitee.com/example/project_a.git</span><br><span class=\"line\">https://gitee.com/example/project_b.git</span><br></pre></td></tr></table></figure>\n<p>使用shell脚本逐行读取url，并调用Gitea api迁移仓库。</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">!/bin/bash</span></span><br><span class=\"line\"></span><br><span class=\"line\">for line in $(&lt;gitee-url.txt);</span><br><span class=\"line\">do</span><br><span class=\"line\"><span class=\"meta\">\t\t#</span><span class=\"bash\"> Windows注释下面这行</span></span><br><span class=\"line\">    line=$(echo $line | sed -e 's/\\r//g');</span><br><span class=\"line\">    tmp=$&#123;line#https://gitee.com/xxx/&#125;;</span><br><span class=\"line\">    project_name=$&#123;tmp%.git&#125;;</span><br><span class=\"line\">    curl -X POST \"http://git.i.example.com/api/v1/repos/migrate?access_token=&lt;your gitea admin access token&gt;\" -H \"accept: application/json\" -H \"Content-Type: application/json\" -d \"&#123; \\\"auth_password\\\": \\\"NDY2&amp;F*K!hL75y*z\\\", \\\"auth_username\\\": \\\"korvin101@gmail.com\\\", \\\"clone_addr\\\": \\\"$line\\\", \\\"issues\\\": true, \\\"labels\\\": true, \\\"milestones\\\": true, \\\"mirror\\\": true, \\\"private\\\": true, \\\"pull_requests\\\": true, \\\"releases\\\": true, \\\"repo_name\\\": \\\"$project_name\\\", \\\"uid\\\": 2, \\\"wiki\\\": true&#125;\";</span><br><span class=\"line\">done</span><br></pre></td></tr></table></figure>\n<p><strong>[操作2]</strong>：从Gitee上同步最新代码</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">for line in $(&lt;gitee-url.txt);</span><br><span class=\"line\">do</span><br><span class=\"line\">    line=$(echo $line | sed -e 's/\\r//g');</span><br><span class=\"line\">    tmp=$&#123;line#https://gitee.com/xxx/&#125;;</span><br><span class=\"line\">    project_name=$&#123;tmp%.git&#125;;</span><br><span class=\"line\">    curl -X POST \"http://git.i.example.com/api/v1/repos/&#123;owner&#125;/$project_name/mirror-sync?access_token=&lt;your gitea admin access token&gt;\" -H \"accept: application/json\"</span><br><span class=\"line\">done</span><br></pre></td></tr></table></figure>\n<p><strong><em>注：</em></strong>owner为项目拥有者用户名/组织名</p>\n<p><strong>[操作3]</strong>：原本地仓库Git远程仓库地址替换</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// http地址</span><br><span class=\"line\">// 原代码仓库http地址：https://gitee.com/example/project_a.git</span><br><span class=\"line\">// 新代码仓库http地址：http://git.i.example.com/JIANSU/project_a.git</span><br><span class=\"line\">// https://gitee.com/example &gt; http://git.i.example.com/JIANSU</span><br><span class=\"line\">// 本地仓库使用此命令替换，可在包含所有项目的外层文件夹路径下执行批量替换</span><br><span class=\"line\">// Windows删除'.bak'</span><br><span class=\"line\">sed -i '.bak' 's/https:\\/\\/gitee\\.com\\/example/http:\\/\\/git\\.i\\.example.com\\/JIANSU/g' */.git/config</span><br><span class=\"line\"></span><br><span class=\"line\">// ssh地址</span><br><span class=\"line\">// 原代码仓库ssh地址：git@gitee.com:example/project_a.git</span><br><span class=\"line\">// 新代码仓库地址：ssh://git@git.i.example.com:10022/JIANSU/project_a.git</span><br><span class=\"line\">// git@gitee.com:example &gt; ssh://git@git.i.example.com:10022/JIANSU</span><br><span class=\"line\">// 本地仓库使用此命令替换，可在包含所有项目的外层文件夹路径下执行批量替换</span><br><span class=\"line\">// Windows删除'.bak'</span><br><span class=\"line\">sed -i '.bak' 's/git@gitee\\.com:example/ssh:\\/\\/git@git\\.i\\.example\\.com:10022\\/JIANSU/g' */.git/config</span><br></pre></td></tr></table></figure>\n<ol>\n<li><p>如果之前是用http地址进行克隆的仓库的话，现在就是在进行pull和push操作时，把账户密码换成Gitea的就可以了；</p>\n</li>\n<li><p>如果以前是用ssh克隆的仓库的话，现在在Gitea的设置&gt;SSH / GPG 密钥里添加一下公钥就可以进行git pull/git push等操作了；</p>\n</li>\n</ol>\n<h3 id=\"仓库备份\"><a href=\"#仓库备份\" class=\"headerlink\" title=\"仓库备份\"></a>仓库备份</h3><p>Gitea有自己的备份与恢复功能<a href=\"https://docs.gitea.io/zh-cn/backup-and-restore/#%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D\" target=\"_blank\" rel=\"noopener\">备份与恢复</a>，这个备份比较全面，数据/代码/日志都可以备份，正是因为这样，如果仓库比较多这个备份的文件肯定会有点大，而且每次都是全量备份，所以频率肯定不能太高，而我只是想对仓库代码做一个高频率备份，所以写了一个Python3脚本调用Gitea api和 Git命令来进行所有仓库的所有分支代码备份，因为这个备份基于Git机制，所以虽然频率高，但备份始终只有一份。脚本如下：</p>\n<p>backup.py</p>\n<blockquote>\n<p>如果使用python2运行，分支名里有中文的话，请自行处理字符编码问题。</p>\n</blockquote>\n<p>** python<br><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#!/usr/bin/python3</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> os</span><br><span class=\"line\"><span class=\"keyword\">import</span> platform</span><br><span class=\"line\"><span class=\"keyword\">import</span> requests</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">current_dir = os.path.abspath(os.path.dirname(__file__))</span><br><span class=\"line\">access_token = <span class=\"string\">\"&lt;your access token&gt;\"</span></span><br><span class=\"line\">repos_url = <span class=\"string\">'http://git.i.example.com/api/v1/repos/search?access_token=&#123;&#125;&amp;page=&#123;&#125;&amp;limit=&#123;&#125;'</span></span><br><span class=\"line\">branches_url = <span class=\"string\">'http://git.i.example.com/api/v1/repos/&#123;&#125;/branches?access_token=&#123;&#125;'</span></span><br><span class=\"line\">repo_key_url = <span class=\"string\">'http://git.i.example.com/api/v1/repos/&#123;&#125;/&#123;&#125;/keys?access_token=&#123;&#125;'</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">repos</span><span class=\"params\">()</span>:</span></span><br><span class=\"line\">    page = <span class=\"number\">1</span></span><br><span class=\"line\">    limit = <span class=\"number\">50</span></span><br><span class=\"line\">    has_next = <span class=\"keyword\">True</span></span><br><span class=\"line\">    <span class=\"keyword\">while</span> has_next:</span><br><span class=\"line\">        r = requests.get(repos_url.format(access_token, page, limit))</span><br><span class=\"line\">        <span class=\"keyword\">for</span> repo <span class=\"keyword\">in</span> r.json()[<span class=\"string\">'data'</span>]:</span><br><span class=\"line\">            <span class=\"keyword\">yield</span> repo</span><br><span class=\"line\">        page += <span class=\"number\">1</span></span><br><span class=\"line\">        has_next = len(r.json()[<span class=\"string\">'data'</span>]) == limit</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">\"\"\"拉取项目所有分支代码到本地\"\"\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">sync_repo</span><span class=\"params\">()</span>:</span></span><br><span class=\"line\">    repo_index = <span class=\"number\">0</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> repo <span class=\"keyword\">in</span> repos():</span><br><span class=\"line\">        repo_index += <span class=\"number\">1</span></span><br><span class=\"line\">        <span class=\"comment\"># 克隆仓库</span></span><br><span class=\"line\">        os.chdir(current_dir)</span><br><span class=\"line\">        print(<span class=\"string\">'克隆第 &#123;&#125; 个仓库 &#123;&#125; '</span>.format(repo_index, repo[<span class=\"string\">'name'</span>]))</span><br><span class=\"line\">        os.system(<span class=\"string\">\"git clone &#123;&#125;\"</span>.format(repo[<span class=\"string\">'ssh_url'</span>]))</span><br><span class=\"line\">        os.chdir(os.path.join(current_dir, repo[<span class=\"string\">'name'</span>]))</span><br><span class=\"line\">        <span class=\"comment\"># 更新仓库</span></span><br><span class=\"line\">        print(<span class=\"string\">'同步 &#123;&#125; 仓库所有分支'</span>.format(repo[<span class=\"string\">'name'</span>]))</span><br><span class=\"line\">        os.system(<span class=\"string\">'git fetch --all'</span>)</span><br><span class=\"line\">        <span class=\"comment\"># if platform.system() == 'Windows':</span></span><br><span class=\"line\">        <span class=\"comment\"># Windows</span></span><br><span class=\"line\">        branches = requests.get(branches_url.format(</span><br><span class=\"line\">            repo[<span class=\"string\">'full_name'</span>], access_token)).json()</span><br><span class=\"line\">        <span class=\"keyword\">for</span> branch <span class=\"keyword\">in</span> branches:</span><br><span class=\"line\">            branch_name = branch[<span class=\"string\">'name'</span>]</span><br><span class=\"line\">            os.system(<span class=\"string\">'git branch --track &#123;&#125; origin/&#123;&#125;'</span>.format(branch_name, branch_name))</span><br><span class=\"line\">            <span class=\"comment\"># 用reset而不用pull是因为如果分支被强推了pull下来会有合并冲突，用rest就不会有冲突问题</span></span><br><span class=\"line\">            os.system(<span class=\"string\">'git checkout &#123;&#125; &amp;&amp; git reset --hard origin/&#123;&#125;'</span>.format(branch_name, branch_name))</span><br><span class=\"line\">        <span class=\"comment\"># else:</span></span><br><span class=\"line\">        <span class=\"comment\">#     # Linux/macOS</span></span><br><span class=\"line\">        <span class=\"comment\">#     # git branch -r | grep -v '\\-&gt;' | while read remote; do git branch --track $&#123;remote#origin/&#125; $remote; done &amp;&amp; git fetch --all &amp;&amp; git pull --all</span></span><br><span class=\"line\">        <span class=\"comment\">#     # os.system(\"git branch -r | grep -v '\\-&gt;' | while read remote; do git branch --track $&#123;remote#origin/&#125; $remote; done &amp;&amp; git fetch --all &amp;&amp; git pull --all\")</span></span><br><span class=\"line\">        <span class=\"comment\">#     # # 用reset而不用pull是因为如果分支被强推了pull下来会有合并冲突，用rest就不会有冲突问题</span></span><br><span class=\"line\">        <span class=\"comment\">#     os.system(\"git branch -r | grep -v '\\-&gt;' | while read remote; do git branch --track $&#123;remote#origin/&#125; $remote; git checkout $&#123;remote#origin/&#125;; git reset --hard $remote; done\")</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">\"\"\"设置项目部署公钥\"\"\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">set_pub_key</span><span class=\"params\">()</span>:</span></span><br><span class=\"line\">    repo_index = <span class=\"number\">0</span></span><br><span class=\"line\">    body = &#123;</span><br><span class=\"line\">        <span class=\"string\">\"key\"</span>: <span class=\"string\">\"ssh-rsa aabbcc\"</span>,</span><br><span class=\"line\">        <span class=\"string\">\"read_only\"</span>: <span class=\"keyword\">True</span>,</span><br><span class=\"line\">        <span class=\"string\">\"title\"</span>: <span class=\"string\">\"SandBox\"</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">for</span> repo <span class=\"keyword\">in</span> repos():</span><br><span class=\"line\">        repo_index += <span class=\"number\">1</span></span><br><span class=\"line\">        print(<span class=\"string\">'===&#123;&#125;. &#123;&#125;==='</span>.format(repo_index, repo[<span class=\"string\">'name'</span>]))</span><br><span class=\"line\">        r = requests.post(repo_key_url.format(</span><br><span class=\"line\">            repo[<span class=\"string\">'owner'</span>][<span class=\"string\">'username'</span>], repo[<span class=\"string\">'name'</span>], access_token), data=body)</span><br><span class=\"line\">        print(r.json())</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> __name__ == <span class=\"string\">'__main__'</span>:</span><br><span class=\"line\">    sync_repo()</span><br><span class=\"line\">    <span class=\"comment\"># set_pub_key()</span></span><br></pre></td></tr></table></figure></p>\n<p>可以把脚本放在本地，使用cron(Linux/macOS)/计划任务(Windows)定时运行<code>python backup.py</code></p>\n<p><em><a href=\"https://blog.csdn.net/flydragon0815/article/details/46006473\" target=\"_blank\" rel=\"noopener\">Windows计划任务运行cmd命令时，可使用非当前登录用户运行，这样就不会弹出小黑窗。</a></em></p>\n","raw":null,"categories":[{"name":"程序猿","path":"api/categories/程序猿.json"}],"tags":[{"name":"Python","path":"api/tags/Python.json"},{"name":"Git","path":"api/tags/Git.json"},{"name":"Gitee","path":"api/tags/Gitee.json"},{"name":"GitLab","path":"api/tags/GitLab.json"},{"name":"Gite","path":"api/tags/Gite.json"},{"name":"Gogs","path":"api/tags/Gogs.json"},{"name":"迁移","path":"api/tags/迁移.json"},{"name":"代码","path":"api/tags/代码.json"}]}]}